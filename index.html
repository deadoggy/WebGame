<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script language="JavaScript" type="text/javascript" src="js/phaser.js"></script>
</head>
<body>
 <script language="JavaScript" type = text/javascript>

     //设置画布宽和高
     var width = 1600;
     var height = 852;
     //实例化游戏
     var game = new Phaser.Game(width, height, Phaser.AUTO, '#game');

     var states = {
         preload : function(){
             this.preload = preloadLogic;
         },
         created : function(){
             this.create = createdLogic;
         },
         play    : function(){
             this.create = playLogic
         },
         over    : function(){}
     }

     //把游戏场景加入到游戏中
     Object.keys(states).map(function(key){
         game.state.add(key, states[key]);
     })

     //各个场景的代码
     //preload
     function preloadLogic(){
         //加载飞机资源
         //game.load.atlasXML('plane_assets', 'resource/AirplaneResource/ui/shoot.png', 'resource/AirplaneResource/ui/shoot.plist');

         //飞机的静态资源
         game.load.image('enemy1', 'resource/AirplaneResource/ui/shoot/enemy1.png')
         game.load.image('enemy2', 'resource/AirplaneResource/ui/shoot/enemy2.png')
         game.load.image('enemy3', 'resource/AirplaneResource/ui/shoot/enemy3_n1.png')
         game.load.image('hero1', 'resource/AirplaneResource/ui/shoot/hero1.png')
         game.load.image('hero2', 'resource/AirplaneResource/ui/shoot/hero2.png')

         //加载背景资源
         game.load.image('background', 'resource/AirplaneResource/ui/shoot_background/background.png')
         //加载按钮
         game.load.image('start_btn', 'resource/AirplaneResource/game_start.png')
         //加载bgm
         game.load.audio('bgm', 'resource/frontier.mp3');


         console.log("before");
         // 添加进度文字
         var progressText = game.add.text(game.world.centerX, game.world.centerY, '0%', {
             fontSize: '60px',
             fill: '#ffffff'
         });
         console.log("after")
         progressText.anchor.setTo(0.5, 0.5); // 设置锚点，用于居中
         // 监听加载完一个文件的事件
         game.load.onFileComplete.add(function(progress) {
             progressText.text = progress + '%';
         });

         //log
         console.log("load done")

         game.load.onLoadComplete.add(loadFinish);

         var flag = false;

         setTimeout(function(){
             flag = true;
         }, 1000);

         function loadFinish(){
             if(true == flag){
                 game.state.start('created');
             }else{
                 setTimeout(loadFinish, 100);
             }
         }
     }


     function createdLogic(){
         console.log("create")
         var bg = game.add.image(0, 0, 'background');
         bg.width = game.world.width;
         bg.height = game.world.height;

         //bgm
         var bgMusic = game.add.audio('bgm');
         //bgMusic.loopFull();
         //添加游戏标题
         var title = game.add.text(game.world.centerX , game.world.centerY*0.8, "Starsun", {
             fontSize: '70px',
             fill : '#4F4F4F'
         });
         title.anchor.setTo(0.5, 0.5);

         //添加开始按钮
         var begBtn = game.add.button(game.world.centerX, game.world.centerY*1.2, 'start_btn', function(){
             game.state.start('play');
         });



         begBtn.anchor.setTo(0.5,0.5);

         //添加背景中的飞机
         var timeflag = false;
         function addEne(){
             if(!timeflag){
                 createRandomEnemyForCreate(10 , 1);
             }
             setTimeout(addEne, 6000);
         }

         addEne();



     }

     function playLogic(){



     }

     function overLogic(){


     }

     function createRandomEnemyForCreate(gap, speed){
         console.log("create once");
         createRandomEnemy(gap, speed,[-1,-1], "enemy1");
     }




     function createRandomEnemy(gap, speed, hero, enemeyType){

        var randomPosLen = Math.random() * 2 * (width + height);
        var originX, originY;
        var targetX, targetY;
        var currentX, currentY;

        //随机生成初始点
        if(randomPosLen>=0 && randomPosLen < width){
            originX = randomPosLen; originY = 0;
        }else if(randomPosLen >= width && randomPosLen < width + height){
            originX = width; originY = randomPosLen = width;
        }else if(randomPosLen >= width + height && randomPosLen < 2 * width + height){
            originX = width - (randomPosLen - height - width); originY = height;
        }else{
            originX = 0; originY = height - (randomPosLen - height - 2 * width);
        }

        currentX = originX;
        currentY = originY;

        //确定目标点
        if(-1 == hero[0] && -1 == hero[1]){
            targetX = Math.random() * width;
            targetY = Math.random() * height;
        }else{
            targetX = hero[0];
            targetY = hero[1];
        }

        var distance = game.math.distance(originX, originY, targetX, targetY);

        //移动的步长
        var xStep = (targetX - originX) * speed / distance;
        var yStep = (targetY - originY) * speed / distance;

        //初始
        var enemy = game.add.sprite(originX,originY, enemeyType);

        //旋转角度
        var rotate = game.math.radToDeg(Math.acos((targetY-originY)/distance));

        if(originX < targetX){
            rotate = -rotate;
        }

        enemy.angle = rotate;

        refresh();


        function refresh(){
            currentX += xStep;
            currentY += yStep;
            if((currentX >=0 && currentX <= width) && (currentY >= 0 && currentY<=height)){
                enemy.reset(currentX, currentY);
                setTimeout(refresh, gap);
            }else{
                //console.log("current:(" + currentX + ":" + currentY + ")");
                enemy.kill();
            }


        }

     }

     // 启动游戏
     game.state.start('preload');

 </script>
 <div id = "game"></div>
</body>
</html>