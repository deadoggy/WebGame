<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script language="JavaScript" type="text/javascript" src="js/phaser.js"></script>
</head>
<body>
 <script language="JavaScript" type = text/javascript>

     //设置画布宽和高
     var width = 1600;
     var height = 852;
     //实例化游戏
     var game = new Phaser.Game(width, height, Phaser.AUTO, '#game');

     var states = {
         preload : function(){
             this.preload = preloadLogic;
         },
         created : function(){
             this.create = createdLogic;
         },
         play    : function(){
             this.create = playLogic
         },
         over    : function(){}
     }

     //把游戏场景加入到游戏中
     Object.keys(states).map(function(key){
         game.state.add(key, states[key]);
     })

     //各个场景的代码
     //preload
     function preloadLogic(){
         //加载飞机资源
         //game.load.atlasXML('plane_assets', 'resource/AirplaneResource/ui/shoot.png', 'resource/AirplaneResource/ui/shoot.plist');

         //飞机的静态资源
         game.load.image('enemy1', 'resource/AirplaneResource/ui/shoot/enemy1.png')
         game.load.image('enemy2', 'resource/AirplaneResource/ui/shoot/enemy2.png')
         game.load.image('enemy3', 'resource/AirplaneResource/ui/shoot/enemy3_n1.png')
         game.load.image('hero1', 'resource/AirplaneResource/ui/shoot/hero1.png')
         game.load.image('hero2', 'resource/AirplaneResource/ui/shoot/hero2.png')

         //加载背景资源
         game.load.image('background', 'resource/AirplaneResource/ui/shoot_background/background.png')
         //加载按钮
         game.load.image('start_btn', 'resource/AirplaneResource/game_start.png')
         //加载bgm
         game.load.audio('bgm', 'resource/frontier.mp3');


         console.log("before");
         // 添加进度文字
         var progressText = game.add.text(game.world.centerX*0, game.world.centerY, '0%', {
             fontSize: '60px',
             fill: '#ffffff'
         });
         console.log("after")
         progressText.anchor.setTo(0.5, 0.5); // 设置锚点，用于居中
         // 监听加载完一个文件的事件
         game.load.onFileComplete.add(function(progress) {
             progressText.text = progress + '%';
         });

         //log
         console.log("load done")

         game.load.onLoadComplete.add(loadFinish);

         var flag = false;

         setTimeout(function(){
             flag = true;
         }, 1000);

         function loadFinish(){
             if(true == flag){
                 game.state.start('created');
             }else{
                 setTimeout(loadFinish, 100);
             }
         }
     }


     function createdLogic(){
         console.log("create")
         var bg = game.add.image(0, 0, 'background');
         bg.width = game.world.width;
         bg.height = game.world.height;

         //bgm
         var bgMusic = game.add.audio('bgm');
         //bgMusic.loopFull();
         //添加游戏标题
         var title = game.add.text(game.world.centerX , game.world.centerY*0.8, "Starsun", {
             fontSize: '70px',
             fill : '#4F4F4F'
         });
         title.anchor.setTo(0.5, 0.5);

         //添加开始按钮
         var begBtn = game.add.button(game.world.centerX, game.world.centerY*1.2, 'start_btn', function(){
             game.state.start('play');
         });



         begBtn.anchor.setTo(0.5,0.5);

         //添加背景中的飞机
         var timeflag = false;
         function addEne(){
             if(!timeflag){
                 createRandomEnemyForCreate(10 , 3);
             }

             //setTimeout(addEne, 6000);
         }

         addEne();



     }

     function playLogic(){



     }

     function overLogic(){


     }

     function createRandomEnemyForCreate(gap, speed){
         console.log("create once");
         createRandomEnemy(gap, speed,[-1,-1]);
         //createRandomEnemy(enemyGroup, gap, speed,[-1,-1]);

     }




     function createRandomEnemy(gap, speed, hero){

         var enemyList = ['enemy1', 'enemy2'];
         var xRand = Math.random();
         var yRand = Math.random();
         var enemyRand1 = Math.ceil(Math.random()*1000) % 2;
         var enemyRand2 = Math.ceil(Math.random()*1000) % 2;

         var xEne;
         var yEne;

         var xEneX, xEneY;
         var yEneX, yEneY;

         var targetX, targetY;

         //设置方向
         if(hero[0] == -1 && hero[1] == -1){ //如果没有指定目标, 就随机方向

             targetX = Math.random() * Math.random() * width;
             targetY = Math.random() * Math.random() * height;
         }else{
             //从x轴和y轴出发的点的角度不一样
             targetX = hero[0];
             targetY = hero[1];

         }

         console.log("tarX:" + targetX + " tarY:" + targetY);


         //根据随机数确定初始位置并初始化精灵
         if(yRand < 0.5){xEneX = 20;}
         else{ xEneX = game.world.centerX*2}
         xEneY = game.world.centerY * 2 * xRand;
         xEne = game.add.sprite(xEneX, xEneY,enemyList[enemyRand1]);
         xEne.anchor.setTo(0.5, 0.5);

         yEneX = game.world.centerX*2*yRand;
         if(xRand < 0.5){yEneY = 20;}
         else{ yEneY = game.world.centerY*2}
         yEne = game.add.sprite(yEneX, yEneY, enemyList[enemyRand2]);
         xEne.anchor.setTo(0.5,0.5);

         var disX = game.math.distance(targetX, targetY, xEneX, xEneY);
         console.log("disX:" + disX);
         var disY = game.math.distance(targetX, targetY, yEneX, yEneY);
         console.log("disY:" + disY);
         var xxDis = speed * (targetX-xEneX) / disX;
         var xyDis = speed * (targetY-xEneY) / disX;
         var yxDis = speed * (targetX-yEneX) / disY;
         var yyDis = speed * (targetY-yEneY) / disY;
         console.log("xorX:"+xEneX + "xorY:" + xEneY);
         console.log("yorX:"+yEneX + "yorY:" + yEneY);


         if((xEneX < 0.5 )){
             xEne.angle = -game.math.radToDeg(Math.acos((targetY-xEneY) / disX));
         }else{
             xEne.angle = game.math.radToDeg(Math.acos((targetY-xEneY) / disX));
         }

         if((yEneX < 0.5 )){
             yEne.angle = -game.math.radToDeg(Math.acos((targetY-yEneY) / disY));
         }else{
             yEne.angle = game.math.radToDeg(Math.acos((targetY-yEneY) / disY));
         }




         newLocation();

         //更新位置的函数
         function newLocation(){


             //更新坐标
             xEneX = xEneX + xxDis;
             xEneY = xEneY + xyDis;
             yEneY = yEneY + yyDis;
             yEneX = yEneX + yxDis;

             if(null != xEne){
                 xEne.reset(xEneX, xEneY);
             }

             if(null != yEne){
                 yEne.reset(yEneY, yEneY);
             }

             if(null != xEne || null != yEne){
                 setTimeout(function(){
                     newLocation();
                 }, gap);
             }

         }

     }

     // 启动游戏
     game.state.start('preload');

 </script>
 <div id = "game"></div>
</body>
</html>